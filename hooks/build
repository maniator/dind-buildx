#!/bin/bash -ex

WORKDIR=$PWD
IMAGE_NAME=${IMAGE_NAME:-maniator/docker-with-buildx}
DOCKERFILE_PATH=${DOCKERFILE_PATH:-$WORKDIR/Dockerfile}
DOCKER_TAG=${DOCKER_TAG:-latest}
DOCKER_CONFIG=${DOCKER_CONFIG:-$WORKDIR/.docker}
BUILDX_DIR=$DOCKER_CONFIG/buildx

run_docker () {
    mkdir -p "$BUILDX_DIR"
    docker run --rm \
        -e DOCKER_TLS_CERTDIR=/certs \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v "$BUILDX_DIR":/env_configs/.docker/buildx \
        -v "$WORKDIR":"$WORKDIR" -w "$WORKDIR" maniator/docker-with-buildx "$@"
}

run_build () {
    run_docker build -f "$DOCKERFILE_PATH" \
        -t "$IMAGE_NAME" --target=buildx_image \
        --load . "$@"
}

# "this" implies a pull request test build
if [ "$DOCKER_TAG" = latest ] || [ "$DOCKER_TAG" = this ]; then
    run_build --build-arg DOCKER_VERSION=latest --build-arg BUILDX_VERSION=latest
else
    grep_tags=$(echo "$DOCKER_TAG" | grep -Eo '(docker_|buildx_)?(([0-9]+\.){2}[0-9]+)')
    build_tags=$(echo "$grep_tags" | xargs -I '{}' -t sh -c "./hooks/build_tags '{}'" )

    export -f run_build run_docker 
    export BUILDX_DIR WORKDIR IMAGE_NAME DOCKERFILE_PATH
    echo "$build_tags" | xargs -n 10 -I '{}' -t bash -c "run_build {}"
fi
